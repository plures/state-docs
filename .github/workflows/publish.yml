name: Publish

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG"
      
      - name: Update deno.json version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "Error: VERSION is empty"
            exit 1
          fi
          # Use deno eval with error handling
          deno eval "
            try {
              const filePath = 'deno.json';
              const version = '${VERSION}';
              
              // Validate inputs
              if (!version || version.trim() === '') {
                throw new Error('Version is empty or invalid');
              }
              
              // Check if file exists
              try {
                await Deno.stat(filePath);
              } catch (err) {
                throw new Error(\`File not found: \${filePath}\`);
              }
              
              // Read and parse JSON
              const fileContent = await Deno.readTextFile(filePath);
              let denoJson;
              try {
                denoJson = JSON.parse(fileContent);
              } catch (err) {
                throw new Error(\`Invalid JSON in \${filePath}: \${err instanceof Error ? err.message : String(err)}\`);
              }
              
              // Ensure denoJson is an object
              if (typeof denoJson !== 'object' || denoJson === null) {
                throw new Error(\`Expected \${filePath} to contain a JSON object\`);
              }
              
              // Update version
              denoJson.version = version;
              
              // Write back
              await Deno.writeTextFile(filePath, JSON.stringify(denoJson, null, 2) + '\n');
              
              console.log(\`Successfully updated \${filePath} to version \${version}\`);
            } catch (err) {
              console.error('Error updating deno.json:', err instanceof Error ? err.message : String(err));
              Deno.exit(1);
            }
          "
          echo "Updated deno.json to version $VERSION"
          cat deno.json
      
      - name: Update package.json.template version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "Error: VERSION is empty"
            exit 1
          fi
          # Use deno eval with error handling
          deno eval "
            try {
              const filePath = 'package.json.template';
              const version = '${VERSION}';
              
              // Validate inputs
              if (!version || version.trim() === '') {
                throw new Error('Version is empty or invalid');
              }
              
              // Check if file exists
              try {
                await Deno.stat(filePath);
              } catch (err) {
                throw new Error(\`File not found: \${filePath}\`);
              }
              
              // Read and parse JSON
              const fileContent = await Deno.readTextFile(filePath);
              let pkgJson;
              try {
                pkgJson = JSON.parse(fileContent);
              } catch (err) {
                throw new Error(\`Invalid JSON in \${filePath}: \${err instanceof Error ? err.message : String(err)}\`);
              }
              
              // Ensure pkgJson is an object
              if (typeof pkgJson !== 'object' || pkgJson === null) {
                throw new Error(\`Expected \${filePath} to contain a JSON object\`);
              }
              
              // Update version
              pkgJson.version = version;
              
              // Write back
              await Deno.writeTextFile(filePath, JSON.stringify(pkgJson, null, 2) + '\n');
              
              console.log(\`Successfully updated \${filePath} to version \${version}\`);
            } catch (err) {
              console.error('Error updating package.json.template:', err instanceof Error ? err.message : String(err));
              Deno.exit(1);
            }
          "
          echo "Updated package.json.template to version $VERSION"
          cat package.json.template
      
      - name: Build npm package
        run: deno task build:npm
        continue-on-error: false
      
      - name: Publish to JSR (Deno)
        env:
          DENO_KV_ACCESS_TOKEN: ${{ secrets.JSR_TOKEN }}
        run: |
          if [ -z "$DENO_KV_ACCESS_TOKEN" ]; then
            echo "Warning: JSR_TOKEN not set. Attempting OIDC authentication..."
            deno publish --allow-dirty || echo "JSR publish failed - check authentication"
          else
            deno publish --allow-dirty --token="$DENO_KV_ACCESS_TOKEN"
          fi
      
      - name: Publish to npm
        working-directory: ./npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "Error: NPM_TOKEN secret is not configured"
            echo "Please add NPM_TOKEN to repository secrets"
            exit 1
          fi
          npm publish --access public
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.tag }} release
          body: |
            Release ${{ steps.version.outputs.tag }}
            
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
